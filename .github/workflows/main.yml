name: Check and Download New Release

on:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          lfs: true
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: Clean git history but keep files
        run: |
          # å¤‡ä»½å½“å‰æ–‡ä»¶ï¼ˆæ’é™¤.gitç›®å½•ï¼‰
          echo "å¤‡ä»½å½“å‰æ–‡ä»¶..."
          mkdir -p /tmp/repo_backup
          rsync -av --exclude='.git' --exclude='.gitattributes' . /tmp/repo_backup/
          
          # ä¿å­˜å½“å‰çš„.gitattributesæ–‡ä»¶ï¼ˆåŒ…å«LFSé…ç½®ï¼‰
          if [ -f .gitattributes ]; then
            cp .gitattributes /tmp/repo_backup/
          fi
          
          # åˆ é™¤.gitç›®å½•å¹¶é‡æ–°åˆå§‹åŒ–
          rm -rf .git
          git init
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # æ¢å¤.gitattributesæ–‡ä»¶
          if [ -f /tmp/repo_backup/.gitattributes ]; then
            cp /tmp/repo_backup/.gitattributes .
          fi
          
          # é…ç½®LFS
          git config --global lfs.https://github.com/${{ github.repository }}.git/info/lfs.locksverify false
          git lfs install --local
          
          # æ·»åŠ è¿œç¨‹ä»“åº“ï¼ˆå…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼‰
          git remote remove origin 2>/dev/null || true
          git remote add origin https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # æ¢å¤æ‰€æœ‰æ–‡ä»¶
          echo "æ¢å¤æ–‡ä»¶..."
          rsync -av --exclude='.git' /tmp/repo_backup/ .
          
          # æ¸…ç†å¤‡ä»½
          rm -rf /tmp/repo_backup
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ°æ–°ä»“åº“
          git add --all
          
          # å¦‚æœæœ‰æ›´æ”¹ï¼Œæäº¤åˆå§‹æäº¤
          if ! git diff --cached --quiet; then
            git commit -m "åˆå§‹æäº¤ - æ¸…ç†å†å²è®°å½•"
          fi

      - name: Setup Git and LFS
        run: |
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # é…ç½®LFSï¼ˆç¦ç”¨é”å®šAPIä»¥é¿å…é”™è¯¯ï¼‰
          git config --global lfs.https://github.com/${{ github.repository }}.git/info/lfs.locksverify false
          
          # å®‰è£…å¹¶åˆå§‹åŒ–Git LFS
          git lfs install --local
          git lfs pull

      - name: Ensure LFS tracking
        run: |
          # ç¡®ä¿APKæ–‡ä»¶è¢«LFSè·Ÿè¸ª
          if ! git lfs ls-files | grep -q "web/apk_files/.*\.apk"; then
            echo "Configuring LFS tracking for APK files..."
            git lfs track "web/apk_files/*.apk"
            git add .gitattributes
            git commit -m "Update LFS tracking for APK files" || echo "No changes to commit"
          fi

      - name: Check latest release
        id: check_release
        run: |
          # è·å–FCLé¡¹ç›®çš„æœ€æ–°å‘è¡Œç‰ˆä¿¡æ¯
          curl -s https://api.github.com/repos/FCL-Team/FoldCraftLauncher/releases/latest > latest_release.json
          LATEST_TAG=$(jq -r '.tag_name' latest_release.json)
          
          # è·å–å½“å‰ä»“åº“ä¸­çš„æœ€æ–°å·²çŸ¥ç‰ˆæœ¬
          if [ -f .latest_version ]; then
            CURRENT_VERSION=$(cat .latest_version)
          else
            CURRENT_VERSION="v0.0.0"
          fi
          
          echo "Latest version: $LATEST_TAG"
          echo "Current version: $CURRENT_VERSION"
          
          # æ¯”è¾ƒç‰ˆæœ¬
          if [ "$LATEST_TAG" != "$CURRENT_VERSION" ]; then
            echo "NEW_RELEASE=true" >> $GITHUB_ENV
            echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          else
            echo "NEW_RELEASE=false" >> $GITHUB_ENV
          fi

      - name: Clean old APK files
        if: env.NEW_RELEASE == 'true'
        run: |
          # åˆ é™¤ç°æœ‰çš„web/apk_filesç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
          if [ -d "web/apk_files" ]; then
            echo "Cleaning old APK files..."
            rm -rf web/apk_files/*
          else
            mkdir -p web/apk_files
          fi

      - name: Download and process new release
        if: env.NEW_RELEASE == 'true'
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•ä¸‹è½½æ–‡ä»¶
          mkdir -p temp_download
          cd temp_download
          
          # è·å–å‘è¡Œç‰ˆçš„èµ„äº§ä¸‹è½½URL
          jq -r '.assets[].browser_download_url' ../latest_release.json | while read url; do
            if [ ! -z "$url" ]; then
              echo "Downloading $url"
              curl -L -O "$url"
            fi
          done
          
          cd ..
          rm latest_release.json
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨ä¸”ä¸ºç©º
          mkdir -p web/apk_files
          
          # ç§»åŠ¨æ‰€æœ‰.apkæ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•
          find temp_download -name "*.apk" -exec mv {} web/apk_files/ \;
          
          # åˆ é™¤ä¸´æ—¶ç›®å½•
          rm -rf temp_download

      - name: Filter APK files (keep only 'all' versions)
        if: env.NEW_RELEASE == 'true'
        run: |
          echo "Filtering APK files, keeping only 'all' versions..."
          
          # éå†web/apk_filesç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
          for file in web/apk_files/*.apk; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              # å¦‚æœæ–‡ä»¶åä¸åŒ…å«"all"ï¼Œåˆ™åˆ é™¤è¯¥æ–‡ä»¶
              if [[ ! "$filename" == *"all"* ]]; then
                echo "Removing non-all version: $filename"
                rm "$file"
              else
                echo "Keeping all version: $filename"
              fi
            fi
          done
          
          # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ–‡ä»¶å‰©ä½™
          remaining_files=$(find web/apk_files -name "*.apk" | wc -l)
          echo "Remaining APK files: $remaining_files"
          
          if [ "$remaining_files" -eq 0 ]; then
            echo "Warning: No 'all' version APK files found!"
          fi

      - name: Add filtered files to git
        if: env.NEW_RELEASE == 'true'
        run: |
          # ç¡®ä¿LFSè·Ÿè¸ªAPKæ–‡ä»¶
          git lfs track "web/apk_files/*.apk"
          git add .gitattributes
          
          # å¼ºåˆ¶æ·»åŠ æ‰€æœ‰APKæ–‡ä»¶ï¼ˆåŒ…æ‹¬åˆ é™¤çš„æ–‡ä»¶ï¼‰
          git add --all web/apk_files/
          
          # æ›´æ–°ç‰ˆæœ¬è®°å½•æ–‡ä»¶
          echo "$LATEST_TAG" > .latest_version
          git add .latest_version

      - name: Generate download page
        if: env.NEW_RELEASE == 'true'
        run: |
          # åˆ›å»ºwebç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          mkdir -p web
          
          # è¯»å–æœ€æ–°ç‰ˆæœ¬å·
          LATEST_VERSION=$(cat .latest_version)
          
          # è·å–APKæ–‡ä»¶åˆ—è¡¨ï¼ˆç°åœ¨åªåŒ…å«allç‰ˆæœ¬ï¼‰
          APK_FILES=$(find web/apk_files -name "*.apk" -type f | sort)
          
          # ç”ŸæˆHTMLä¸‹è½½é¡µé¢åˆ°webç›®å½•
          cat > web/index.html << EOF
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>FCLå¯åŠ¨å™¨ä¸‹è½½ç«™</title>
              <style>
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      max-width: 1000px;
                      margin: 0 auto;
                      padding: 20px;
                      background-color: #f5f5f5;
                  }
                  .header {
                      text-align: center;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 30px;
                      border-radius: 10px;
                      margin-bottom: 30px;
                  }
                  .version-info {
                      background-color: white;
                      padding: 20px;
                      border-radius: 10px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                      margin-bottom: 20px;
                      text-align: center;
                  }
                  .download-list {
                      background-color: white;
                      padding: 20px;
                      border-radius: 10px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                  }
                  .file-item {
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      padding: 15px;
                      border-bottom: 1px solid #eee;
                  }
                  .file-item:last-child {
                      border-bottom: none;
                  }
                  .file-name {
                      font-weight: 500;
                      color: #333;
                      flex: 1;
                  }
                  .download-btn {
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 8px 16px;
                      text-decoration: none;
                      border-radius: 5px;
                      transition: transform 0.2s;
                  }
                  .download-btn:hover {
                      transform: translateY(-2px);
                      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                  }
                  .footer {
                      text-align: center;
                      margin-top: 30px;
                      color: #666;
                      font-size: 14px;
                  }
                  .note {
                      background-color: #fff3cd;
                      border: 1px solid #ffeaa7;
                      border-radius: 5px;
                      padding: 15px;
                      margin-bottom: 20px;
                      color: #856404;
                  }
                  .download-tip {
                      background-color: #e3f2fd;
                      border: 1px solid #bbdefb;
                      border-radius: 5px;
                      padding: 15px;
                      margin-bottom: 20px;
                      color: #1565c0;
                  }
                  .recommendation {
                      background-color: #e8f5e9;
                      border: 1px solid #c8e6c9;
                      border-radius: 5px;
                      padding: 15px;
                      margin-bottom: 20px;
                  }
                  .recommendation h4 {
                      margin-top: 0;
                      color: #2e7d32;
                  }
                  @media (max-width: 600px) {
                      .file-item {
                          flex-direction: column;
                          align-items: flex-start;
                      }
                      .download-btn {
                          margin-top: 10px;
                          align-self: flex-end;
                      }
                  }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ğŸš€ FCLå¯åŠ¨å™¨ä¸‹è½½ç«™</h1>
                  <p>Fold Craft Launcher - ç¨³å®šç‰ˆæœ¬ä¸‹è½½</p>
              </div>
              
              <div class="version-info">
                  <h2>æœ€æ–°ç‰ˆæœ¬: <span style="color: #667eea;">$LATEST_VERSION</span></h2>
                  <p>é€šç”¨ç‰ˆæœ¬ (all) - åŒ…å«æ‰€æœ‰æ¶æ„ï¼Œæ¨èä¸‹è½½</p>
              </div>
              
              <div class="note">
                  <strong>ğŸ“ è¯´æ˜ï¼š</strong> æœ¬ç«™åªæä¾›é€šç”¨ç‰ˆæœ¬ (all)ï¼Œè¯¥ç‰ˆæœ¬åŒ…å«æ‰€æœ‰CPUæ¶æ„ï¼Œå…¼å®¹æ€§æœ€å¥½ã€‚
              </div>
              
              <div class="download-tip">
                  <strong>âš¡ ä¸‹è½½æç¤ºï¼š</strong> å¦‚éœ€æ›´å¿«çš„ä¸‹è½½é€Ÿåº¦ï¼Œå»ºè®®ä½¿ç”¨å¤šçº¿ç¨‹ä¸‹è½½å·¥å…·å¦‚ IDMã€FDM æˆ– Aria2 ç­‰ã€‚
              </div>
              
              <div class="recommendation">
                  <h4>ğŸ“² å¤šçº¿ç¨‹ä¸‹è½½å·¥å…·æ¨è</h4>
                  <p>å¦‚æœæ‚¨åœ¨æ‰‹æœºä¸Šéœ€è¦æ›´å¿«çš„ä¸‹è½½é€Ÿåº¦ï¼Œå¯ä»¥ä¸‹è½½è¿™æ¬¾å®Œå…¨å…è´¹çš„å¤šçº¿ç¨‹ä¸‹è½½å™¨ï¼š</p>
                  <p><a href="https://gitee.com/cyf112233/tttt/releases/download/dfdfdf/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6app.apk" class="download-btn">ä¸‹è½½å¤šçº¿ç¨‹ä¸‹è½½å™¨(å®‰å“ç‰ˆ)</a></p>
                  <p>å¬ç€ï¼Œè¿™ä»–å¦ˆçš„æ˜¯å…è´¹çš„ï¼ŒèŠ±é’±æˆ‘åƒå²ï¼Œä½ åªéœ€è¦é•¿æŒ‰ä¸‹è½½æŒ‰é’®ï¼Œå¤åˆ¶é“¾æ¥ï¼Œå»è¿™é‡Œé¢ä¸‹ï¼Œé€Ÿåº¦å¿«100å€</p>
              </div>
              
              <div class="download-list">
                  <h3>ğŸ“¦ FCLå¯åŠ¨å™¨ä¸‹è½½</h3>
          EOF
          
          # æ·»åŠ æ–‡ä»¶åˆ—è¡¨
          for file in $APK_FILES; do
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)
              file_path="apk_files/$filename"
              cat >> web/index.html << EOF
                  <div class="file-item">
                      <div class="file-name">$filename</div>
                      <div>
                          <span style="color: #666; margin-right: 15px;">å¤§å°: $filesize</span>
                          <a href="$file_path" class="download-btn" download>ä¸‹è½½APK</a>
                      </div>
                  </div>
          EOF
          done
          
          # æ·»åŠ HTMLå°¾éƒ¨
          cat >> web/index.html << EOF
              </div>
              
              <div class="footer">
                  <p>è‡ªåŠ¨æ›´æ–°äº: $(date '+%Y-%m-%d %H:%M:%S')</p>
              </div>
          </body>
          </html>
          EOF
          
          # æ·»åŠ webç›®å½•åˆ°git
          git add web/

      - name: Commit and push changes
        if: env.NEW_RELEASE == 'true'
        run: |
          # æäº¤æ‰€æœ‰æ›´æ”¹
          git commit -m "è‡ªåŠ¨æ›´æ–°åˆ°ç‰ˆæœ¬ $LATEST_TAG" || echo "No changes to commit"
          
          # å¼ºåˆ¶æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼Œè¦†ç›–å†å²
          git push --force origin HEAD:main || git push --force origin HEAD:master

      - name: No new release
        if: env.NEW_RELEASE == 'false'
        run: |
          echo "No new release found. Current version is up to date."
